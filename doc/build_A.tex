\documentclass[11pt]{article}

\usepackage{default}
\usepackage{fullpage}
\usepackage{fancyhdr}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage{setspace}
\usepackage{graphicx}
\usepackage{url}
\usepackage{algorithm}
% \usepackage{algorithmic}
\usepackage{algpseudocode}

\pagestyle{fancy}
\setlength{\headheight}{16pt}
\rhead{\today}

\newcommand{\R}{\mathbb{R}}
\newcommand{\Z}{\mathbb{Z}}

\newcommand{\F}{{\cal F}}
\renewcommand{\P}{\mathbb{P}}
\newcommand{\E}{\mathbb{E}}
\newcommand{\p}[1]{\P \left\{ #1 \right\}}
\newcommand{\e}[1]{\E \left[ #1 \right]}
\newcommand{\ee}[2]{E_{#1} \left[ #2 \right]}
\newcommand{\var}[1]{\mbox{Var} \left( #1 \right)}
\newcommand{\cov}[1]{\mbox{Cov} \left( #1 \right)}
\newcommand{\cor}[1]{\mbox{Corr} \left( #1 \right)}

% Notation for my attempt at formulating LRSLP-2
\newcommand{\qt}{\tilde{q}}
\newcommand{\Dt}{\tilde{D}}
\newcommand{\dt}{\tilde{d}}
\newcommand{\Bt}{\tilde{B}}

\newcommand{\xs}{x^*}
\newcommand{\xh}{\hat{x}}
\newcommand{\lh}{\hat{\lambda}}
\newcommand{\mh}{\hat{\mu}}

\newcommand{\st}{\mbox{s.t.}}

\DeclareMathOperator*{\argmax}{arg\,max}
\DeclareMathOperator*{\argmin}{arg\,min}

% For OMRP:
\newcommand{\gb}{\bar{G}}
\newcommand{\gbb}{\bar{\gb}}
\newcommand{\db}{\bar{D}}
\newcommand{\dbb}{\bar{\db}}
\newcommand{\xit}{\xi}  %% CHANGED THIS TO BE WITHOUT TILDE! 
\newcommand{\xiti}{\xit^i}

\newtheorem{theorem}{Theorem}

\bibliographystyle{plain}

% Commands for build_A.m variable names
\newcommand{\buildA}{\texttt{build\_A.m}}
\newcommand{\A}{\texttt{A}}
\newcommand{\Ast}{\texttt{A\_st}}
\newcommand{\Alag}{\texttt{A\_lag}}
\newcommand{\xr}{\texttt{xr}}
\newcommand{\xb}{\texttt{xb}}
\newcommand{\xe}{\texttt{xe}}
\newcommand{\xa}{\texttt{xa}}
\newcommand{\xu}{\texttt{xu}}
\newcommand{\sourceN}{\texttt{sourceN}}
\newcommand{\userN}{\texttt{userN}}
\newcommand{\ST}{\texttt{ST}}
\newcommand{\sw}{\texttt{sw\_row}}
\newcommand{\gw}{\texttt{gw\_row}}

\begin{document}

\section{Constraint building code as its written}

The basic constraint matrices constructed in $\buildA$, $\A$ and $\Ast$, are composed of of a series of submatrices, as
\[
	\A = 
	\left(
	\begin{array}{ccccc}
		A &   S & R   & -I & 0 \\
		A_b & 0 & R_b &  0 & 0 \\
		L &   0 & 0   &  I & 0
	\end{array}
	\right),
\]
where $I$ is the identity matrix of appropriate size and $0$ are the matrices of zeros of appropriate size, and
\[
	\Ast = 
	\left(
	\begin{array}{ccccc}
		A' & S'   & 0 & 0 & 0 \\
		0  & S'_b & 0 & 0 & 0 \\
		L' & 0    & 0 & 0 & 0
	\end{array}
	\right).
\]
These matrices have sizes and index variables given in the following tables.
The horizontal and vertical labels indicate first the number of rows or columns, with the variable used to index each section in parentheses. 
The table for $\A$:
\begin{center}
	\begin{tabular}{r|c|c|c|c|c}
		& $\sourceN\cdot\userN$ ($\xa$) & $\sourceN$ ($\xu$) & $\sourceN$ ($\xu + \sourceN$) & $\userN$ () & $1$ () \\
		\hline
		\userN (\xr) & $A$   & $S$ & $R$   & $-I$ & $0$ \\
		\ST (\xb)    & $A_b$ & $0$ & $R_b$ & $0$  & $0$ \\
		\userN (\xr) & $L$   & $0$ & $0$   & $I$  & $0$ \\
		\hline
	\end{tabular}
\end{center}

And for \Ast:
\begin{center}
	\begin{tabular}{r|c|c|c|c|c}
		& $\sourceN\cdot\userN$ ($\xa$) & $\sourceN$ ($\xu$) & $\sourceN$ ($\xu + \sourceN$) & $\userN$ () & $1$ () \\
		\hline
		\userN (\xr) & $A'$  & $S'$    & $0$ & $0$ & $0$ \\
		\ST (\xb)    & $0$   & $S'_b$  & $0$ & $0$ & $0$ \\
		\userN (\xr) & $L'$  & $0$     & $0$ & $0$ & $0$ \\
		\hline
	\end{tabular}
\end{center}

Note: With the patches that Alicia supplied to correct the $\xb$ problem, the $\xb$ rows in the matrix will be indexed by the variables $\gw$ (for groundwater sources) and $\sw$ (for surface water sources).

These submatrices fit together in a block bi-diagonal form, which for 4 time periods looks like
\[
	\left(
	\begin{array}{cccc}
		\A   &      &      &    \\
		\Ast & \A   &      &    \\
		     & \Ast & \A   &    \\
		     &      & \Ast & \A 
	\end{array}
	\right).
\]

In the interest of making the linear program more computationally tractable, I propose to eliminate the lower $\userN$ constraints and the rightmost $\userN+1$ variables in both $\A$ and $\Ast$.
Making the LP smaller should make it easier to solve numerically in a stable way.
As of this writing, this idea is purely hypothetical, but I will discuss it next.

\section*{Constraint Matrices for other time lags}

When time steps other than a year are used, the matrix \Ast is broken up into two pieces: \Ast\ and \Alag.
Matrix \Ast\ still handles storage that is available in the next time period.
Matrix \Alag\ handles storage that is not available until some number of periods in the future, specified by \texttt{timeLag}.
As the code is currently written, the only options are \texttt{timeLag = 1} (for 1-year time steps) and \texttt{timeLag = 12} (for 1-month time steps).
For illustration purposes, the constraint matrix is constructed as follows for \texttt{timeLag = 3}
\[
	\left(
	\begin{array}{ccccc}
		\A    &       &      &      &    \\
		\Ast  & \A    &      &      &    \\
		      & \Ast  & \A   &      &    \\
		\Alag &       & \Ast & \A   &    \\
		      & \Alag &      & \Ast & \A
	\end{array}
	\right).
\]
Note that for \texttt{timeLag = 1} the matrices \Ast\ and \Alag\ will overlap, and thus are added together.

\section*{Proposed changes to constraint building code}

I begin with some notation.
Let the decision vector for time period $n$, collectively $x^n$, be composed of the following components:
\begin{enumerate}
	\item $x^n_a$ are decisions indexed by $\xa$, which determine flow.
	\item $x^n_s$ are decisions indexed by $\xu$, which define storage between time periods.
	\item $x^n_r$ are decisions indexed by $\xu+\sourceN$, which define water release.
	\item $x^n_I$ are decisions corresponding to the identity matrices in $\A$.
	\item For brevity, I will omit the final column which is never filled in.
\end{enumerate}

Then expanding the constraints for a single intermediate time period will look like
\[
	\begin{array}{rrrrrrl}
		A' x^{n-1}_a & + S' x^{n-1}_s   & + A x^n_a   & + S x^n_s & + R x^n_r   & - Ix^n_I  & = b_\text{demand} \\
		             & + S'_b x^{n-1}_s & + A_b x^n_a &           & + R_b x^n_r &           & = b_\text{supply} \\
		L' x^{n-1}_a &                  & + L x^n_a   &           &             & + I x^n_I & = 0.
	\end{array}
\]

I propose to simply add together the first and last sets of constraints to arrive at an equivalent but smaller formulation.
The variables $x_I$ are used only to connect the two sets of constraints, so removing them should be painless.
The smaller set of constraints I propose will be
\[
	\begin{array}{rrrrrl}
		(A'+L') x^{n-1}_a & + S' x^{n-1}_s   & + (A+L) x^n_a   & + S x^n_s & + R x^n_r   & = b_\text{demand} \\
		                  & + S'_b x^{n-1}_s & + A_b x^n_a     &           & + R_b x^n_r & = b_\text{supply}.
	\end{array}
\]
This will remove $\userN$ constraints and $\userN$ variables from each time period.
The total system loss can be computed simply with $(1, 1, \dots, 1) (L'+L) (x^1_a, x^2_a, \dots, x^{41}_a) - L' x^{41}_a$.
The final term is important for the boundary condition: there is no computed loss after the final time period.

\end{document}